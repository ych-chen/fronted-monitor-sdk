<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Monitor SDK - Vanilla JS Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary { background-color: #2196F3; color: white; }
        .btn-success { background-color: #4CAF50; color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-warning { background-color: #ff9800; color: white; }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid;
        }

        .status.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        input[type="text"], input[type="number"] {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .metrics-display {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Frontend Monitor SDK - Vanilla JS Example</h1>

        <div id="status" class="status info">
            Initializing monitor...
        </div>

        <div class="hidden" id="user-section">
            <h2 id="welcome-message">Welcome!</h2>
            <p>User ID: <span id="user-id">-</span></p>
        </div>

        <div>
            <h3>Test Actions</h3>

            <button class="btn-primary" onclick="handleLogin()">
                Simulate Login
            </button>

            <button class="btn-success" onclick="handleSuccessOperation()">
                Successful Operation
            </button>

            <button class="btn-danger" onclick="handleErrorOperation()">
                Trigger Error
            </button>

            <button class="btn-warning" onclick="handleAsyncOperation()">
                Async Operation
            </button>
        </div>

        <div>
            <h3>Test Custom Metrics</h3>
            <input type="number" id="metric-value" placeholder="Metric value" value="100">
            <input type="text" id="metric-label" placeholder="Label" value="test">

            <button class="btn-primary" onclick="recordCustomMetric()">
                Record Metric
            </button>

            <button class="btn-success" onclick="incrementCounter()">
                Increment Counter
            </button>
        </div>

        <div>
            <h3>Test User Interactions</h3>
            <button class="btn-primary" onclick="recordButtonClick('purchase')">
                Record Purchase Click
            </button>

            <button class="btn-warning" onclick="recordButtonClick('share')">
                Record Share Click
            </button>

            <input type="text" id="test-input" placeholder="Type something..."
                   oninput="handleInput()">
        </div>

        <div>
            <h3>Test Performance Metrics</h3>
            <button class="btn-primary" onclick="recordPerformanceMetrics()">
                Record Performance Data
            </button>
        </div>

        <div class="metrics-display" id="metrics-log">
            <strong>Metrics Log:</strong><br>
            <div id="metrics-content">Waiting for data...</div>
        </div>

        <div class="status info" style="margin-top: 20px;">
            <strong>How to test:</strong><br>
            1. Open browser developer tools<br>
            2. Check Network tab for OTLP requests<br>
            3. Look at Console for SDK logs<br>
            4. Check your collector endpoint for traces and metrics
        </div>
    </div>

    <!-- 注意：在实际使用中，这里应该引入构建后的UMD文件 -->
    <script src="../dist/index.umd.js"></script>

    <script>
        let monitor;
        let currentUser = null;
        let metricsLog = [];

        // 初始化监控
        async function initializeMonitor() {
            try {
                monitor = FrontendMonitorSDK.createFrontendMonitor();

                await monitor.init({
                    serviceName: 'vanilla-js-example',
                    serviceVersion: '1.0.0',
                    endpoint: 'https://your-collector.example.com',
                    apiKey: 'your-api-key',
                    sampleRate: 1.0,
                    enablePerformanceMonitoring: true,
                    enableErrorMonitoring: true,
                    enableUserInteractionMonitoring: true,
                    attributes: {
                        environment: 'development',
                        framework: 'vanilla-js',
                    },
                });

                updateStatus('✅ Monitor SDK initialized successfully', 'success');
                logMetric('SDK initialized');

                // 设置全局错误处理
                window.addEventListener('error', (event) => {
                    logMetric('Global error captured: ' + event.message);
                });

            } catch (error) {
                updateStatus('❌ Failed to initialize monitor: ' + error.message, 'error');
                console.error('Monitor initialization failed:', error);
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            logMetric(`Status: ${message}`);
        }

        function logMetric(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            metricsLog.push(logEntry);

            // 保持最近20条记录
            if (metricsLog.length > 20) {
                metricsLog.shift();
            }

            document.getElementById('metrics-content').innerHTML = metricsLog.join('<br>');
        }

        function handleLogin() {
            const tracing = monitor.startTracing('user_login', {
                attributes: {
                    login_method: 'web',
                    timestamp: Date.now(),
                },
            });

            try {
                // 模拟登录过程
                logMetric('Starting login process...');

                setTimeout(() => {
                    currentUser = {
                        id: 'user_' + Math.random().toString(36).substr(2, 9),
                        name: 'Demo User',
                        email: 'demo@example.com'
                    };

                    document.getElementById('user-section').classList.remove('hidden');
                    document.getElementById('welcome-message').textContent = `Welcome, ${currentUser.name}!`;
                    document.getElementById('user-id').textContent = currentUser.id;

                    const metrics = monitor.getMetricsCollector();
                    metrics.incrementCounter('user_logins_total', 1, {
                        status: 'success',
                        method: 'web'
                    });

                    tracing.endSpan();
                    updateStatus('✅ Login successful', 'success');
                    logMetric('Login completed successfully');
                }, 1000);

            } catch (error) {
                tracing.recordError(error);
                tracing.endSpan();
                updateStatus('❌ Login failed: ' + error.message, 'error');
                logMetric('Login failed: ' + error.message);
            }
        }

        function handleSuccessOperation() {
            const tracing = monitor.startTracing('successful_operation', {
                attributes: {
                    operation_type: 'test',
                    user_id: currentUser?.id || 'anonymous'
                },
            });

            setTimeout(() => {
                const metrics = monitor.getMetricsCollector();
                metrics.incrementCounter('successful_operations_total', 1, {
                    operation: 'test'
                });
                metrics.recordHistogram('operation_duration_ms', 500, {
                    operation: 'test'
                });

                tracing.endSpan();
                updateStatus('✅ Successful operation completed', 'success');
                logMetric('Successful operation completed');
            }, 500);
        }

        function handleErrorOperation() {
            const tracing = monitor.startTracing('error_operation');

            try {
                // 故意抛出错误
                throw new Error('This is a test error for demonstration');
            } catch (error) {
                monitor.recordError(error, {
                    user_action: 'trigger_error',
                    user_id: currentUser?.id || 'anonymous'
                });

                tracing.recordError(error);
                tracing.endSpan();

                updateStatus('❌ Error recorded successfully', 'error');
                logMetric('Test error recorded');
            }
        }

        async function handleAsyncOperation() {
            const tracing = monitor.startTracing('async_operation');

            try {
                logMetric('Starting async operation...');

                // 模拟异步API调用
                await new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (Math.random() > 0.3) {
                            resolve('Success');
                        } else {
                            reject(new Error('Async operation failed'));
                        }
                    }, 1500);
                });

                const metrics = monitor.getMetricsCollector();
                metrics.incrementCounter('async_operations_total', 1, {
                    status: 'success'
                });

                tracing.endSpan();
                updateStatus('✅ Async operation completed successfully', 'success');
                logMetric('Async operation succeeded');

            } catch (error) {
                tracing.recordError(error);
                tracing.endSpan();

                const metrics = monitor.getMetricsCollector();
                metrics.incrementCounter('async_operations_total', 1, {
                    status: 'error',
                    error_type: error.message
                });

                updateStatus('❌ Async operation failed: ' + error.message, 'error');
                logMetric('Async operation failed: ' + error.message);
            }
        }

        function recordCustomMetric() {
            const value = parseFloat(document.getElementById('metric-value').value) || 0;
            const label = document.getElementById('metric-label').value || 'unknown';

            const metrics = monitor.getMetricsCollector();
            metrics.recordHistogram('custom_metric', value, {
                label: label
            });

            logMetric(`Custom metric recorded: ${value} (label: ${label})`);
        }

        function incrementCounter() {
            const label = document.getElementById('metric-label').value || 'unknown';

            const metrics = monitor.getMetricsCollector();
            metrics.incrementCounter('custom_counter', 1, {
                label: label
            });

            logMetric(`Counter incremented (label: ${label})`);
        }

        function recordButtonClick(action) {
            monitor.recordUserInteraction({
                type: 'click',
                element: 'button',
                target: action,
                timestamp: Date.now(),
                user_id: currentUser?.id
            });

            const metrics = monitor.getMetricsCollector();
            metrics.incrementCounter('button_clicks_total', 1, {
                action: action,
                user_id: currentUser?.id || 'anonymous'
            });

            logMetric(`Button click recorded: ${action}`);
        }

        function handleInput() {
            const input = document.getElementById('test-input');
            monitor.recordUserInteraction({
                type: 'input',
                element: 'input',
                target: 'test-input',
                timestamp: Date.now(),
                value: input.value.length > 0 ? 'has_content' : 'empty',
                length: input.value.length
            });
        }

        function recordPerformanceMetrics() {
            const mockMetrics = {
                pageLoadTime: Math.random() * 2000 + 500,
                timeToFirstByte: Math.random() * 500 + 100,
                firstContentfulPaint: Math.random() * 1500 + 300,
                largestContentfulPaint: Math.random() * 3000 + 800,
                firstInputDelay: Math.random() * 100,
                cumulativeLayoutShift: Math.random() * 0.3
            };

            monitor.recordMetrics(mockMetrics);

            logMetric('Performance metrics recorded:');
            Object.entries(mockMetrics).forEach(([key, value]) => {
                logMetric(`  ${key}: ${value.toFixed(2)}`);
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializeMonitor);

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            if (monitor) {
                monitor.destroy();
                logMetric('Monitor destroyed');
            }
        });
    </script>
</body>
</html>